name: Tagged Release

on:
  push:
    tags:
      - CLOUDT-1030

permissions: write-all

jobs:
  projects-to-build:
    runs-on: ubuntu-latest

  build-offline-installation-image:
    needs:
      - projects-to-build
      - build-projects
    runs-on:
      - self-hosted
      - k8s
      - prod
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start local Docker registry
        run: |
          docker run --restart=always -d -p 5000:5000 --name image-registry registry:2
          docker buildx create --name mybuilder --use --driver docker-container
          docker buildx inspect --bootstrap
